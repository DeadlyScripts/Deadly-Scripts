local cloneref = cloneref or clonefunction or function(instance) return instance end
local protectgui = protectgui or (syn and syn.protect_gui) or function() end
local gethui = gethui or function() return cloneref(game:GetService("CoreGui")) end

if shared["alsllalslallalalalalallalallalalalla-chatenable"] then
    return
end
shared["alsllalslallalalalalallalallalalalla-chatenable"] = true

local API_URL = "https://chat-2g3u.onrender.com"

local HttpService = cloneref(game:GetService("HttpService"))
local Players = cloneref(game:GetService("Players"))
local StarterGui = cloneref(game:GetService("StarterGui"))
local TextChatService = cloneref(game:GetService("TextChatService"))
local UserInputService = cloneref(game:GetService("UserInputService"))
local TweenService = cloneref(game:GetService("TweenService"))
local ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local JobId = game.JobId
local PlaceId = game.PlaceId

shared.DeadlyChatSettings = shared.DeadlyChatSettings or {
    SendToRobloxChat = false,
    IgnoreRobloxChat = true,
    ChatPosition = UDim2.new(0.00741, 0, 0.05851, 0),
    UserColors = {},
    ChatMode = "Local"
}

local LastMessageTimestamp = 0
local MessageCache = {}
local GlobalMessages = {}
local LocalMessages = {}
local CurrentChatVisible = true
local ChatInputFocused = false
local SendToRobloxChat = shared.DeadlyChatSettings.SendToRobloxChat
local JustSentToRoblox = false
local IgnoreRobloxChat = shared.DeadlyChatSettings.IgnoreRobloxChat or false
local ChatMode = shared.DeadlyChatSettings.ChatMode
local POLLING_INTERVAL = 2
local MAX_MESSAGES = 50
local PollingActive = true
local PollingThread = nil

local function Request(url, method, body)
    local success, result = pcall(function()
        return request({
            Url = url,
            Method = method or "GET",
            Headers = { ["Content-Type"] = "application/json" },
            Body = body and HttpService:JSONEncode(body) or nil
        })
    end)

    if success and result and result.StatusCode == 200 then
        local decoded
local ok = pcall(function()
    decoded = HttpService:JSONDecode(result.Body)
end)
return ok, decoded

    end

    return false, nil
end

-- disabled chat function (ITS FUCKING EASY BRO I JUST WATCHED A YOUTUBE TUTORIAL)
StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, false)

if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
    local chatWindowConfiguration = TextChatService:WaitForChild("ChatWindowConfiguration")
    local chatInputBarConfiguration = TextChatService:WaitForChild("ChatInputBarConfiguration")
    
    chatWindowConfiguration.Enabled = false
    chatInputBarConfiguration.Enabled = false
    
    if TextChatService:FindFirstChild("ChannelTabsConfiguration") then
        TextChatService.ChannelTabsConfiguration.Enabled = false
    end
end


local LMG2L = {}
LMG2L["ScreenGui_1"] = Instance.new("ScreenGui", PlayerGui)
LMG2L["ScreenGui_1"]["ZIndexBehavior"] = Enum.ZIndexBehavior.Sibling
LMG2L["ScreenGui_1"]["ResetOnSpawn"] = false

local success = pcall(function()
    LMG2L["ScreenGui_1"].Parent = gethui()
    protectgui(LMG2L["ScreenGui_1"])
end)

if not success or not LMG2L["ScreenGui_1"].Parent then
    LMG2L["ScreenGui_1"].Parent = PlayerGui
end

LMG2L["Chat System_2"] = Instance.new("Frame", LMG2L["ScreenGui_1"])
LMG2L["Chat System_2"]["BorderSizePixel"] = 0
LMG2L["Chat System_2"]["BackgroundColor3"] = Color3.fromRGB(39, 39, 39)
LMG2L["Chat System_2"]["Size"] = UDim2.new(0.3963, 0, 0.31649, 0)
LMG2L["Chat System_2"]["Position"] = shared.DeadlyChatSettings.ChatPosition
LMG2L["Chat System_2"]["BorderColor3"] = Color3.fromRGB(28, 42, 54)
LMG2L["Chat System_2"]["Name"] = "Chat System"
LMG2L["Chat System_2"]["BackgroundTransparency"] = 0.4

LMG2L["Bar_3"] = Instance.new("Frame", LMG2L["Chat System_2"])
LMG2L["Bar_3"]["BorderSizePixel"] = 0
LMG2L["Bar_3"]["BackgroundColor3"] = Color3.fromRGB(42, 42, 42)
LMG2L["Bar_3"]["Size"] = UDim2.new(1, 0, 0.21008, 0)
LMG2L["Bar_3"]["Position"] = UDim2.new(0, 0, -0.14286, 0)
LMG2L["Bar_3"]["BorderColor3"] = Color3.fromRGB(28, 42, 54)
LMG2L["Bar_3"]["Name"] = "Bar"

LMG2L["Local/Global Toggle_4"] = Instance.new("TextButton", LMG2L["Bar_3"])
LMG2L["Local/Global Toggle_4"]["TextWrapped"] = true
LMG2L["Local/Global Toggle_4"]["RichText"] = true
LMG2L["Local/Global Toggle_4"]["BorderSizePixel"] = 0
LMG2L["Local/Global Toggle_4"]["TextSize"] = 20
LMG2L["Local/Global Toggle_4"]["TextScaled"] = true
LMG2L["Local/Global Toggle_4"]["BackgroundColor3"] = Color3.fromRGB(0, 185, 255)
LMG2L["Local/Global Toggle_4"]["FontFace"] = Font.new("rbxasset://fonts/families/FredokaOne.json", Enum.FontWeight.Regular, Enum.FontStyle.Normal)
LMG2L["Local/Global Toggle_4"]["Size"] = UDim2.new(0.14953, 0, 0.84, 0)
LMG2L["Local/Global Toggle_4"]["Text"] = ChatMode
LMG2L["Local/Global Toggle_4"]["Name"] = "Local/Global Toggle"
LMG2L["Local/Global Toggle_4"]["Position"] = UDim2.new(0.8271, 0, 0.08, 0)
LMG2L["Local/Global Toggle_4"]["TextColor3"] = Color3.fromRGB(255, 255, 255)

LMG2L["UICorner_5"] = Instance.new("UICorner", LMG2L["Local/Global Toggle_4"])

LMG2L["TextLabel_6"] = Instance.new("TextLabel", LMG2L["Bar_3"])
LMG2L["TextLabel_6"]["TextWrapped"] = true
LMG2L["TextLabel_6"]["BorderSizePixel"] = 0
LMG2L["TextLabel_6"]["TextScaled"] = true
LMG2L["TextLabel_6"]["BackgroundColor3"] = Color3.fromRGB(255, 255, 255)
LMG2L["TextLabel_6"]["FontFace"] = Font.new("rbxasset://fonts/families/FredokaOne.json", Enum.FontWeight.Regular, Enum.FontStyle.Normal)
LMG2L["TextLabel_6"]["TextColor3"] = Color3.fromRGB(255, 255, 255)
LMG2L["TextLabel_6"]["BackgroundTransparency"] = 1
LMG2L["TextLabel_6"]["Size"] = UDim2.new(0.25234, 0, 0.76, 0)
LMG2L["TextLabel_6"]["Text"] = "Deadly Chat"
LMG2L["TextLabel_6"]["Position"] = UDim2.new(0.01402, 0, 0.12, 0)

LMG2L["UICorner_7"] = Instance.new("UICorner", LMG2L["Bar_3"])
LMG2L["UICorner_8"] = Instance.new("UICorner", LMG2L["Chat System_2"])

LMG2L["UIAspectRatioConstraint_9"] = Instance.new("UIAspectRatioConstraint", LMG2L["Chat System_2"])
LMG2L["UIAspectRatioConstraint_9"]["AspectRatio"] = 1.79832

local GlobalMessageScroll = Instance.new("ScrollingFrame", LMG2L["Chat System_2"])
GlobalMessageScroll.Name = "GlobalMessageScroll"
GlobalMessageScroll.Size = UDim2.new(1, -10, 1, -60)
GlobalMessageScroll.Position = UDim2.new(0, 5, 0, 10)
GlobalMessageScroll.BackgroundTransparency = 1
GlobalMessageScroll.BorderSizePixel = 0
GlobalMessageScroll.ScrollBarThickness = 4
GlobalMessageScroll.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
GlobalMessageScroll.ScrollBarImageTransparency = 0.5
GlobalMessageScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
GlobalMessageScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
GlobalMessageScroll.ScrollingDirection = Enum.ScrollingDirection.Y
GlobalMessageScroll.Visible = false

local GlobalMessageLayout = Instance.new("UIListLayout", GlobalMessageScroll)
GlobalMessageLayout.Padding = UDim.new(0, 2)
GlobalMessageLayout.SortOrder = Enum.SortOrder.LayoutOrder
GlobalMessageLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left

local LocalMessageScroll = Instance.new("ScrollingFrame", LMG2L["Chat System_2"])
LocalMessageScroll.Name = "LocalMessageScroll"
LocalMessageScroll.Size = UDim2.new(1, -10, 1, -60)
LocalMessageScroll.Position = UDim2.new(0, 5, 0, 10)
LocalMessageScroll.BackgroundTransparency = 1
LocalMessageScroll.BorderSizePixel = 0
LocalMessageScroll.ScrollBarThickness = 4
LocalMessageScroll.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
LocalMessageScroll.ScrollBarImageTransparency = 0.5
LocalMessageScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
LocalMessageScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
LocalMessageScroll.ScrollingDirection = Enum.ScrollingDirection.Y
LocalMessageScroll.Visible = true

local LocalMessageLayout = Instance.new("UIListLayout", LocalMessageScroll)
LocalMessageLayout.Padding = UDim.new(0, 2)
LocalMessageLayout.SortOrder = Enum.SortOrder.LayoutOrder
LocalMessageLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left


local InputContainer = Instance.new("Frame", LMG2L["Chat System_2"])
InputContainer.Name = "InputContainer"
InputContainer.Size = UDim2.new(1, -10, 0, 40)
InputContainer.Position = UDim2.new(0, 5, 1, -45)
InputContainer.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
InputContainer.BackgroundTransparency = 0.2
InputContainer.BorderSizePixel = 0

local InputCorner = Instance.new("UICorner", InputContainer)
InputCorner.CornerRadius = UDim.new(0, 8)

local ChatInputBox = Instance.new("TextBox", InputContainer)
ChatInputBox.Name = "ChatInputBox"
ChatInputBox.Size = UDim2.new(1, -10, 1, -6)
ChatInputBox.Position = UDim2.new(0, 5, 0, 3)
ChatInputBox.BackgroundTransparency = 1
ChatInputBox.Text = ""
ChatInputBox.PlaceholderText = "Type a message..."
ChatInputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
ChatInputBox.PlaceholderColor3 = Color3.fromRGB(178, 178, 178)
ChatInputBox.Font = Enum.Font.SourceSans
ChatInputBox.TextSize = 16
ChatInputBox.TextXAlignment = Enum.TextXAlignment.Left
ChatInputBox.ClearTextOnFocus = false
ChatInputBox.TextWrapped = false

local function SetCore(name, value)
    repeat
        local success = pcall(function()
            StarterGui:SetCore(name, value)
        end)
        if not success then task.wait() end
    until success
end

local function ShowNotification(title, text, duration)
    SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 3
    })
end

local function SwitchChatView()
    if ChatMode == "Global" then
        GlobalMessageScroll.Visible = true
        LocalMessageScroll.Visible = false
    else
        GlobalMessageScroll.Visible = false
        LocalMessageScroll.Visible = true
    end
end

local function UpdateModeButton()
    if ChatMode == "Global" then
        LMG2L["Local/Global Toggle_4"].BackgroundColor3 = Color3.fromRGB(60, 180, 80)
        LMG2L["Local/Global Toggle_4"].Text = "Global"
    else
        LMG2L["Local/Global Toggle_4"].BackgroundColor3 = Color3.fromRGB(0, 185, 255)
        LMG2L["Local/Global Toggle_4"].Text = "Local"
    end
    SwitchChatView()
end

LMG2L["Local/Global Toggle_4"].MouseButton1Click:Connect(function()
    ChatMode = (ChatMode == "Global") and "Local" or "Global"
    shared.DeadlyChatSettings.ChatMode = ChatMode
    UpdateModeButton()
    ShowNotification("Deadly Chat", "Switched to " .. ChatMode .. " mode", 2)
end)

local function InitSession()
    local success, response = Request(API_URL .. "/api/v1/chat/init", "POST", {
        userId = tostring(Player.UserId),
        username = Player.Name,
        displayName = Player.DisplayName,
        jobId = JobId,
        placeId = tostring(PlaceId)
    })
  
    if success and response and response.success then
        return true
    end
  
    return false
end

local function GetNewMessages()
    local url = API_URL .. "/api/v1/chat/messages?jobId=" .. JobId .. "&chatType=general&limit=50"
    if LastMessageTimestamp > 0 then
        url = url .. "&after=" .. LastMessageTimestamp
    end
  
    local success, response = Request(url, "GET")
  
    if success and response and response.success then
        return response.messages
    end
  
    return {}
end

local function SendMessage(message)
    local success, response = Request(API_URL .. "/api/v1/chat/send", "POST", {
        userId = tostring(Player.UserId),
        username = Player.Name,
        displayName = Player.DisplayName,
        jobId = JobId,
        message = message,
        chatType = "general"
    })
  
    if success and response then
        return response.success, response.message, response.messageData
    end
  
    return false, "Failed to send message", nil
end

local function SendToRoblox(message)
    JustSentToRoblox = true
    pcall(function()
        if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
            local textChannel = TextChatService.TextChannels.RBXGeneral
            textChannel:SendAsync(message)
        else
            ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(message, "All")
        end
    end)
    task.wait(0.5)
    JustSentToRoblox = false
end

local function CleanupOldMessages(scrollFrame, messageTable)
    local messages = {}
  
    for _, child in ipairs(scrollFrame:GetChildren()) do
        if child:IsA("Frame") and child:GetAttribute("MessageTimestamp") then
            table.insert(messages, child)
        end
    end
  
    if #messages > MAX_MESSAGES then
        table.sort(messages, function(a, b)
            return a:GetAttribute("MessageTimestamp") < b:GetAttribute("MessageTimestamp")
        end)
      
        local toRemove = #messages - MAX_MESSAGES
        for i = 1, toRemove do
            messages[i]:Destroy()
            if messageTable then
                table.remove(messageTable, 1)
            end
        end
    end
end

local function GetUserColor(username)
    if not shared.DeadlyChatSettings.UserColors[username] then
        local hash = 0
        for i = 1, #username do
            hash = hash + string.byte(username, i) * i
        end
      
        local hue = (hash % 360) / 360
        local function hsvToRgb(h, s, v)
            local c = v * s
            local x = c * (1 - math.abs((h * 6) % 2 - 1))
            local m = v - c
          
            local r, g, b = 0, 0, 0
            if h < 1/6 then r, g, b = c, x, 0
            elseif h < 2/6 then r, g, b = x, c, 0
            elseif h < 3/6 then r, g, b = 0, c, x
            elseif h < 4/6 then r, g, b = 0, x, c
            elseif h < 5/6 then r, g, b = x, 0, c
            else r, g, b = c, 0, x end
          
            return math.floor((r + m) * 255), math.floor((g + m) * 255), math.floor((b + m) * 255)
        end
      
        local r, g, b = hsvToRgb(hue, 0.7, 0.9)
        shared.DeadlyChatSettings.UserColors[username] = string.format("rgb(%d,%d,%d)", r, g, b)
    end
  
    return shared.DeadlyChatSettings.UserColors[username]
end

local function CreateMessageLabel(scrollFrame, messageTable, username, displayName, message, isSystem, isRobloxChat)
    local timestamp = tick()
  
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(1, -10, 0, 0)
    Container.AutomaticSize = Enum.AutomaticSize.Y
    Container.BackgroundTransparency = 1
    Container.BorderSizePixel = 0
    Container.LayoutOrder = #scrollFrame:GetChildren()
    Container:SetAttribute("MessageTimestamp", timestamp)
    Container.Parent = scrollFrame
  
    local MessageLabel = Instance.new("TextLabel")
    MessageLabel.Size = UDim2.new(1, 0, 0, 0)
    MessageLabel.AutomaticSize = Enum.AutomaticSize.Y
    MessageLabel.BackgroundTransparency = 1
    MessageLabel.BorderSizePixel = 0
    MessageLabel.TextXAlignment = Enum.TextXAlignment.Left
    MessageLabel.TextYAlignment = Enum.TextYAlignment.Top
    MessageLabel.Font = Enum.Font.SourceSansBold
    MessageLabel.TextSize = 15
    MessageLabel.TextWrapped = true
    MessageLabel.RichText = true
    MessageLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    MessageLabel.Parent = Container
  
    if isSystem then
        MessageLabel.Text = string.format("<font color='rgb(255,215,0)'>[SYSTEM]</font> %s", message)
    elseif isRobloxChat then
        local userColor = GetUserColor(username)
        MessageLabel.Text = string.format("<font color='rgb(200,200,200)'>[ROBLOX]</font> <font color='%s'>%s:</font> %s", userColor, displayName or username, message)
    else
        local userColor = GetUserColor(username)
        MessageLabel.Text = string.format("<font color='%s'>%s:</font> %s", userColor, displayName or username, message)
    end
  
    if messageTable then
        table.insert(messageTable, {
            username = username,
            displayName = displayName,
            message = message,
            isSystem = isSystem,
            isRobloxChat = isRobloxChat,
            timestamp = timestamp
        })
    end
  
    CleanupOldMessages(scrollFrame, messageTable)
  
    task.wait(0.01)
    scrollFrame.CanvasPosition = Vector2.new(0, scrollFrame.AbsoluteCanvasSize.Y)
  
    return Container
end

local function AddSystemMessage(text, chatMode)
    if chatMode == "Global" or chatMode == nil then
        CreateMessageLabel(GlobalMessageScroll, GlobalMessages, "", "", text, true, false)
    end
    if chatMode == "Local" or chatMode == nil then
        CreateMessageLabel(LocalMessageScroll, LocalMessages, "", "", text, true, false)
    end
end

local function AddChatMessage(username, displayName, message, isGlobal, isRobloxChat)
    local scrollFrame = isGlobal and GlobalMessageScroll or LocalMessageScroll
    local messageTable = isGlobal and GlobalMessages or LocalMessages
    
    CreateMessageLabel(scrollFrame, messageTable, username, displayName, message, false, isRobloxChat or false)
  
    local character = Players:FindFirstChild(username)
    if character and character:IsA("Player") and not isRobloxChat then
        local char = character.Character
        if char and char:FindFirstChild("Head") then
            task.spawn(function()
                pcall(function()
                    game:GetService("Chat"):Chat(char.Head, message, Enum.ChatColor.White)
                end)
            end)
        end
    end
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
  
    if input.KeyCode == Enum.KeyCode.Slash then
        ChatInputBox:CaptureFocus()
    end
end)

ChatInputBox.FocusLost:Connect(function(enterPressed)
    if enterPressed and ChatInputBox.Text ~= "" then
        local message = ChatInputBox.Text
        ChatInputBox.Text = ""
      
        if SendToRobloxChat then
            SendToRoblox(message)
            AddChatMessage(Player.Name, Player.DisplayName, message, false, true)
        else
            if ChatMode == "Global" then
                local success, responseMsg, messageData = SendMessage(message)
              
                if success and messageData then
                    AddChatMessage(messageData.username, messageData.displayName, messageData.message, true)
                    LastMessageTimestamp = messageData.timestamp
                    MessageCache[messageData.id] = true
                else
                    AddSystemMessage(responseMsg or "Failed to send to global chat", "Global")
                end
            else
                AddChatMessage(Player.Name, Player.DisplayName, message, false, false)
            end
        end
    end
end)

local function InitializeChat()
    AddSystemMessage("Loading Deadly Chat...")
  
    if not InitSession() then
        AddSystemMessage("Failed to initialize session!")
        return
    end
  
    AddSystemMessage("Welcome to Deadly Chat")
    AddSystemMessage("Press '/' to chat")
    AddSystemMessage("Made by Deadly Scripts!")
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player.UserId == 3274233701 then
            AddSystemMessage("<font color='rgb(255,165,0)'>Administrator </font><font color='rgb(255,20,147)'>@rhyan57</font><font color='rgb(255,165,0)'> is in this server</font>", "Global")
            break
        end
    end
  
    local function OnChatted(player, message)
        if JustSentToRoblox and player == Player then return end
        if not IgnoreRobloxChat then
            AddChatMessage(player.Name, player.DisplayName, message, false, true)
        end
    end
  
    for _, player in ipairs(Players:GetPlayers()) do
        player.Chatted:Connect(function(msg) OnChatted(player, msg) end)
    end
  
    Players.PlayerAdded:Connect(function(player)
        player.Chatted:Connect(function(msg) OnChatted(player, msg) end)
      
        if player.UserId == 3274233701 then
            AddSystemMessage("<font color='rgb(255,165,0)'>Administrator </font><font color='rgb(255,20,147)'>@rhyan57</font><font color='rgb(255,165,0)'> joined</font>", "Global")
        end
    end)
end

local function StartPolling()
    PollingThread = coroutine.create(function()
        while PollingActive do
            if not PollingActive then break end
          
            if not LMG2L["ScreenGui_1"] or not LMG2L["ScreenGui_1"].Parent then break end
          
            local newMessages = GetNewMessages()
          
            for _, msg in ipairs(newMessages) do
                if not MessageCache[msg.id] then
                    MessageCache[msg.id] = true
                    LastMessageTimestamp = math.max(LastMessageTimestamp, msg.timestamp)
                  
                    if msg.userId ~= tostring(Player.UserId) then
                        AddChatMessage(msg.username, msg.displayName, msg.message, true, false)
                    end
                end
            end
          
            local startTime = tick()
            while tick() - startTime < POLLING_INTERVAL and PollingActive do
                task.wait(0.1)
                if not PollingActive then break end
            end
        end
    end)
  
    coroutine.resume(PollingThread)
end

task.spawn(function()
    InitializeChat()
    UpdateModeButton()
    StartPolling()
end)
